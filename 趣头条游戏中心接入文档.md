### H5 游戏接入指南

1. 商务洽谈，姜超，微信号：jiangchao900626，QQ：361505385
2. 开发对接，<font color=#FF0000>有问题请在QQ或微信群联系土拨鼠 微信cort-xie qq:691118998，游戏的 app_id （渠道参数）和通信的 app_key （加密参数）可通过“app_id、app_key自主获取”自主获取</font>
3. 按照本文档的说明，打通两边账户、充值
4. **希望接入方能够提供1分钱的充值入口，方便我们充值测试**
### 时序图
![时序图](/out/sequence/sequence.png "时序图")
### 服务器地址

#### 测试：http://newidea4-gamecenter-backend.qttcs3.cn

#### 正式：https://newidea4-gamecenter-backend.1sapp.com

### 错误码
| 错误码 | 说明           |
| :----- | :------------- |
| 10001  | 用户不存在     |
| 10002  | ticket已失效   |
| 10003  | appid不存在    |
| 10004  | openid已失效   |
| 10005  | platform不支持 |
| 10006  | sign错误       |

### app_id、app_key自主获取（仅需要测试环境获取）
注意：<font color=#FF0000>通过这个接口返回的完整 json，在测试环境自测通过后，发给趣头条开发人员，然后由趣头条的工作人员测试，审核，然后上线</font>

示例请求地址：http://newidea4-gamecenter-backend.qttcs3.cn/x/open/test/game/config?name=哈哈&url=http://baidu.com

请求地址
> /x/open/test/game/config

HTTP 请求方式
> GET

注意
> 仅需要测试环境获取

参数

| key  | 必选 | 类型   | 说明     |
| :--- | :--- | :----- | -------- |
| name | true | string | 项目名   |
| url  | true | string | 项目地址 |

返回示例

```

{
  "name": "哈哈da",
  "source": "union",
  "type": "pay",
  "url": "http://baidu.com",
  "open": {
    "app": {
      "id": "a3xNMmCBoKtW",
      "key": "hrth84MED1EgMlhXWmMDAL8FLbiF4BFfvnheWBplcshDBx6B9GhGtg6rEFRhhhAv"
    }
  }
}

```
返回参数说明

再次重申，<font color=#FF0000>通过这个接口返回的完整 json，在测试环境自测通过后，发给趣头条开发人员，然后由趣头条的工作人员测试，审核，将获取的app_id、app_key 配置在线上环境</font>


| key          | 必选 | 类型   | 说明    |
| :----------- | :--- | :----- | ------- |
| open.app.id  | true | string | app_id  |
| open.app.key | true | string | app_key |

### 好消息
<font color=#FF0000>通信加密的算法（sign的生成方式），在“通信加密方式”章节，有go、java、php、js四种语言的demo（其他语言持续更新中），复制下即可搞定sign的算法</font>

签名原串示例

```
请求参数列表：app_id=a3x8z92UnQqG&p1=p1v&t1=t1v&d1=d1v&time=1550631186

生成原串要加上参数app_key: app_id=a3x8z92UnQqG&p1=p1v&t1=t1v&d1=d1v&time=1550631186&app_key=LyHrkdpNVSZjHCQldOtBqZ65iu1nBz3QIcYgDKZopsehdH7aM39dftvHcAlbuFfm

原串：app_ida3x8z92UnQqGapp_keyLyHrkdpNVSZjHCQldOtBqZ65iu1nBz3QIcYgDKZopsehdH7aM39dftvHcAlbuFfmd1d1vp1p1vt1t1vtime1550631186

之后参数列表要删除app_key
```

计算出来的sign

```
6154367d349da5b21f308057ad0b009d
```

### 警告：老用户迁移绑定
<font color=#FF0000>如果之前已经在趣头条游戏中心联运，请将游戏内的唯一标识和openid做绑定，不然会造成用户丢失。</font>

举个例子

老的联运流程是这样的，开发商内唯一标示 -> 用户信息

新的联运就是这样的，openid -> 开发商内唯一标示 -> 用户信息，开发商要做的就是把openid和你们之前用的唯一标示关联起来

案例1

某游戏需要用户登录注册才能玩游戏，那么在通过sdk获取openid之后保存下来，在用户登录注册之后和这个openid关联起来，然后用户下次再来的时候，就不在需要登录这个过程了

如果用户有多个账户的话（这种用户毕竟少数），那就只能绑定一个趣头条的openid了，其他的账户，等用户投诉，要么转义游戏内资源，要么只能注册多个趣头条账户来处理

案例2

某游戏在app本地生成了一个不重复的标示放在cookie里，那么在通过sdk获取openid之后保存下来之后，那么只需要把这个不重复的标示和openid绑定起来，用户之后在玩这个游戏的时候，就不需要那个cookie里存储的标识了

### 获取用户信息

地址
> /x/open/user/ticket

HTTP 请求方式
> GET

提示：ticket值可在跳转URL中获取(测试环境可参考测试流程文档获取游戏跳转测试地址)

参数

| key      | 必选 | 类型   | 说明                             |
| :------- | :--- | :----- | -------------------------------- |
| app_id   | true | string | 项目 id                          |
| platform | true | string | 平台标示                         |
| ticket   | true | string | 获取用户信息临时标识，24小时有效 |
| time     | true | string | unix 时间戳                      |
| sign     | true | string | 签名                             |

返回示例

```
{
  "code": 0,
  "message": "",
  "showErr": 0,
  "currentTime": 0,
  "data": {
    "open_id": "",
    "nickname": "",
    "avatar": ""
  }
}
```

返回参数说明

| key      | 必选 | 类型   | 说明                       |
| :------- | :--- | :----- | -------------------------- |
| open_id  | true | string | 用户在当前项目内的唯一标示 |
| nickname | true | string | 昵称                       |
| avatar   | true | string | 头像                       |


# 游戏中心充值 sdk

### 引入 sdk

#### 测试环境

```
<script type="text/javascript" src="http://newidea4-gamecenter-frontend.1sapp.com/sdk/test/h5.v1.0.0.js"></script>
```

**浏览器调用！**

*模拟测试*

```
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script type="text/javascript" src="http://newidea4-gamecenter-frontend.1sapp.com/sdk/test/h5.v1.0.0.js"></script>
</head>
<body>
<script>
  qttGame.pay({openId: 'u3xvfrT6z123', money: 1, appId: 'a3x8z92Un123', notifyUrl: 'https://www.qutoutiao.net', platform: 'qtt', gameName: '传奇霸业', ext: '{}'})
</script>
</body>
</html>
```

在浏览器中访问以上网页。

![手机浏览器测试](http://static-oss.qutoutiao.net/game/8b0f3a55-4cb8-4f32-83cc-9b284131195a.jpg)

#### 预发布环境

```
<script type="text/javascript" src="http://newidea4-gamecenter-frontend.1sapp.com/sdk/pre/h5.v1.0.0.js"></script>
```

若想在预发布环境测试，首先联系我们这边客服人员添加游戏。
推荐谷歌浏览器访问 [https://newidea4-gamecenter-frontend.1sapp.com/game-test/pages/home/index.html?token=4263s4uIwIfz9jv1SI8snuijcuJnua4HCxH4KmxCk_qroHzGF_AHS3OkVCoBc5pcgIflLbcZY5Y](https://newidea4-gamecenter-frontend.1sapp.com/game-test/pages/home/index.html?token=4263s4uIwIfz9jv1SI8snuijcuJnua4HCxH4KmxCk_qroHzGF_AHS3OkVCoBc5pcgIflLbcZY5Y)


#### 生产环境

```
<script type="text/javascript" src="http://newidea4-gamecenter-frontend.1sapp.com/sdk/prod/h5.v1.0.0.js"></script>
```

### 使用

```
/**
@param money {Number / String} [必填] 充值金额，单位：分，100分 = 1元。
@param notifyUrl {String} [必填] 回调地址，请注意，这个是开发商的充值回调地址
@param openId {String} [必填] openId
@param platform {String} [必填] 平台 目前只有: qtt
@param gameName {String} [选填] 游戏名
@param appId {String} [选填] appId
@param ext {String} [选填] 扩展信息，json格式，比如充值的游戏区服等信息，透明转发
**/
// 示例
qttGame.pay({openId: '3xg4PoJQK4E', money: 1, appId: '3x8z92UnQqG', notifyUrl: '', platform: 'qtt', ext: '{}'})
```

在页面中引入 sdk 后（外部引入或者下载整合到本地代码中），调用 JavaScript 函数 `qttGame.pay(...)`。

调用成功会跳转到充值页面，用户点击支付按钮会调起支付宝/微信支付。

![支付中](https://static-oss.qutoutiao.net/game/sdk/pay.png)

支付成功后会引导用户查询是否支付成功。

![支付完成](https://static-oss.qutoutiao.net/game/sdk/pay-completed.png)

### 充值回调

需要开发商提供一个可访问的充值回调地址，请保持接口的幂等性（保证同一个订单号重复回调不会重复加钱）

HTTP 请求方式
> POST   以 application/x-www-form-urlencoded 方式提交数据

| key       | 必选  | 类型   | 说明                                                   |
| :-------- | :---- | :----- | ------------------------------------------------------ |
| app_id    | true  | string | 项目 id                                                |
| open_id   | true  | string | 用户在当前项目内的唯一标示                             |
| trade_no  | true  | string | 订单号                                                 |
| total_fee | true  | string | 订单金额，单位分，1元=100                              |
| ext       | false | string | 扩展信息，json格式，比如充值的游戏区服等信息，透明转发 |
| time      | true  | string | unix 时间戳                                            |
| sign      | true  | string | 签名                                                  |

充值成功，回调地址请返回如下接口的 json
```
{
    "message":"ok"
}
```

如果回调失败（message!="ok"，就认为是失败），我们这边会继续回调，1/6/16/36/36/36……分钟后继续回调，最多回调16次。

### 充值结果查询
这个接口的作用就是回调开发商支付接口

地址
> /x/pay/union/order/query

HTTP 请求方式
> GET

参数

| key      | 必选 | 类型   | 说明                       |
| :------- | :--- | :----- | -------------------------- |
| trade_no | true | string | 订单号                     |
| app_id   | true | string | 项目 id                    |
| open_id  | true | string | 用户在当前项目内的唯一标示 |

返回示例

```
{
  "code": 0,
  "message": "",
  "showErr": 0,
  "currentTime": 0,
  "data": {
    "trade_no": "",
    "total_fee": 0,
    "status": 0
  }
}
```
返回参数

| key       | 必选 | 类型   | 说明                   |
| :-------- | :--- | :----- | ---------------------- |
| trade_no  | true | string | 订单号                 |
| total_fee | true | string | 金额                   |
| status    | true | int    | -1 未支付，2支付成功，但是回调开发商失败，3：回调开发商成功|

### 充值回调测试（仅测试环境可用）
这个接口的作用就是回调开发商支付接口

地址
> /x/pay/test/notify

HTTP 请求方式
> GET

注意
> 仅测试环境可用

参数

| key        | 必选 | 类型   | 说明                       |
| :--------- | :--- | :----- | -------------------------- |
| trade_no   | true | string | 订单号                     |
| total_fee  | true | string | 金额，单位：分，1元==100   |
| app_id     | true | string | 项目 id                    |
| open_id    | true | string | 用户在当前项目内的唯一标示 |
| notify_url | true | string | 充值回调地址               |
| ext        | true | string | json 字符串                |

返回示例
```
{
  "code": 0,
  "message": "成功",
  "showErr": 0,
  "currentTime": 1550460893,
  "data": {
    "origin": "8409312njkdsaofjkklh3j4hl;kcva890ur93124kjljko;a",
    "sign": "dfalyhuiodwafjld;sauf",
    "message": "ok"
  }
}
```
| key    | 必选 | 类型   | 说明                       |
| :----- | :--- | :----- | -------------------------- |
| origin | true | string | 计算sign的原始字符串       |
| sign   | true | string | sign                       |
| status | true | status | 如果ok，说明成功，不ok的话 |

### 通信加密方式

所有请求的参数，再加上app_key=你的密钥，按照自然排序，然后以k+v的方式拼接在一起，然后在md5，生成sign参数追加为sign=xxxx的参数。

说的再多不如给出代码来的实在，我们会给出 go、php、java、js四种常用语言的加密和解密示例。

go

```
package main

import (
	"crypto/md5"
	"fmt"
	"log"
	"net/url"
	"sort"
	"time"
)

const (
	appID  = "a3x8z92UnQqG"
	appKey = "LyHrkdpNVSZjHCQldOtBqZ65iu1nBz3QIcYgDKZopsehdH7aM39dftvHcAlbuFfm"
)

func main() {
	values := url.Values{}
	values.Add("app_id", appID)
	values.Add("a", "d")
	values.Add("43", "da")
	values.Add("ad", "fas")
	values.Add("time", fmt.Sprintf("%d", time.Now().Unix()))
	s := sign(values)
	values.Add("sign", s)
	log.Println(checkSign(values))
}

func sign(values url.Values) (r string) {
	values.Del("sign")
	values.Add("app_key", appKey)
	keys := make([]string, 0, len(values))
	for k, _ := range values {
		keys = append(keys, k)
	}
	sort.Strings(keys)
	for _, v := range keys {
		r += v + values.Get(v)
	}
	hashed := md5.Sum([]byte(r))
	r = fmt.Sprintf("%x", hashed)
	values.Del("app_key")
	return
}

func checkSign(values url.Values) (ok bool) {
	var sign1 string
	sign1 = values.Get("sign")
	if sign1 == "" {
		log.Panic("sign error")
		return
	}
	sign2 := sign(values)
	values.Del("app_key")
	if sign1 != sign2 {
		log.Panic("sign error")
		return
	}
	ok = true
	return
}

```

******


php

```
const app_id = "a3x8z92UnQqG";
const app_key = "LyHrkdpNVSZjHCQldOtBqZ65iu1nBz3QIcYgDKZopsehdH7aM39dftvHcAlbuFfm";

$params = [
    "app_id" => app_id,
    "a" => "d",
    "43" => "da",
    "ad" => "fas",
    "time" => time(),
];


function sign($params)
{
    unset($params['sign']);
    $params["app_key"] = app_key;
    ksort($params, SORT_NATURAL);
    $sign = '';
    foreach ($params as $k => $v) {
        $sign .= $k . $v;
    }
    unset($params["app_key"]);
    return md5($sign);
}


function checkSign($params)
{
    if (empty($params["sign"])) {
        throw new Exception("sign error");
    }
    $sign = $params["sign"];
    ksort($params, SORT_NATURAL);
    $sign2 = sign($params);
    if ($sign != $sign2) {
        throw new Exception("sign error");
    }
    return true;
}

$sign = sign($params);
$params['sign'] = $sign;
var_dump(checkSign($params));

```

******


java

```
package sign;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.lang.String;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

public class Sign {

	private static final String appID = "a3x8z92UnQqG";
	private static final String appKey = "LyHrkdpNVSZjHCQldOtBqZ65iu1nBz3QIcYgDKZopsehdH7aM39dftvHcAlbuFfm";

	public static void main(String[] args) {
		Map<String,String> Values = new HashMap<>();
		Values.put("app_id", appID);
		Values.put("a", "d");
		Values.put("43", "da");
		Values.put("ad", "fas");
		Values.put("time", Long.toString(new Date().getTime()/1000));
		String s = new Sign().sign(Values);
		System.out.println(s);
		Values.put("sign", s);
		try {
			System.out.println(new Sign().checkSign(Values));
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	public String getMD5(String need2Encode) throws NoSuchAlgorithmException {
        byte[] buf = need2Encode.getBytes();
        MessageDigest md5 = MessageDigest.getInstance("MD5");
        md5.update(buf);
        byte[] tmp = md5.digest();
        StringBuilder sb = new StringBuilder();
        for (byte b : tmp) {
            if (b > 0 && b < 16)
                sb.append("0");
            sb.append(Integer.toHexString(b & 0xff));
        }
        return sb.toString();
    }

	public String sign(Map<String,String> val) {
		val.remove("sign");
		val.put("app_key", appKey);
		ArrayList<String> keys = new ArrayList<>();
		for (String key : val.keySet()) {
			keys.add(key);
		}
		keys.sort(new Comparator<String>() {
			@Override
			public int compare(String l,String r) {
				int i = l.compareTo(r);
				if (i>0) {
					return 1;
				} else {
					return -1;
				}
			}
		});
		String r = "";
		String hashed = "";
		for (String i : keys) {
			r += i+val.get(i);
		}
		try {
		   hashed = getMD5(r);
		} catch (Exception e) {
			e.printStackTrace();
		}
		val.remove("app_key");
		return hashed;
	}

	public boolean checkSign(Map<String,String> val) throws Exception {
		String sign1 = val.get("sign");
		if (sign1 == "") {
			throw new Exception("sign error");
		}
		String sign2 = sign(val);
		val.remove("app_key");
		if (sign1.equals(sign2)==false) {
			throw new Exception("sign error");
		}
		return true;
	}
}
```
******
js

```
const md5 = require('md5');
const appID = "a3x8z92UnQqG";
const appKey = "LyHrkdpNVSZjHCQldOtBqZ65iu1nBz3QIcYgDKZopsehdH7aM39dftvHcAlbuFfm";

main()

function main(){
  const values = {
    app_id: appID,
    a: 'd',
    43: 'da',
    ad: 'fas',
    time: Date.parse(new Date())/1000
  }
  let s = sign(values);
  values.sign = s
  console.log(values, 'values');
  checkSign(values);
}

function sign(values){
  delete values.sign;
  values.app_key = appKey;
  let keysArr = [];
  for(let key in values){
    keysArr.push(key)
  }
  keysArr.sort();
  let keys = ''
  keysArr.forEach((e)=>{
    keys += e;
    keys += values[e];
  });
  console.log(keys)

  let sign = md5(keys);
  return sign;
}

function checkSign(values) {
  let sign1 = values.sign;
  if(!sign1){
    console.log('sign error');
    return false;
  }
  let sign2 = sign(values);
  if (sign1 !== sign2) {
		console.log("sign error")
		return false;
  }
  console.log('ok')
  return true;
}
```




